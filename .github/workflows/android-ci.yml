# Workflow de CI para Android
# Descripción: compila el módulo `app`, ejecuta Detekt y publica los artefactos en una Release de GitHub
name: Android CI

# Permisos: asegurar que el token de Actions pueda crear releases y subir assets
permissions:
  contents: write
  packages: write

# Trigger: ejecutar cuando haya un push a la rama `main`
on:
  push:
    branches: [ main ]

jobs:
  build-and-publish:
    # Job que compila y publica artefactos cuando hay push a `main`
    name: Build and Publish (on main)
    runs-on: ubuntu-latest

    steps:
      # 1) Obtener el código fuente del repositorio
      - name: Checkout
        uses: actions/checkout@v4

      # 2) Configurar Java (JDK 17) necesario para el Android Gradle Plugin
      #    El AGP moderno requiere Java 17; usar JDK 17 evita el fallo:
      #    "Android Gradle plugin requires Java 17 to run. You are currently using Java 11."
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      # 3) Cachear directorios de Gradle para acelerar builds sucesivos
      - name: Cache Gradle packages
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          # La clave usa el contenido del wrapper para invalidar la cache si cambia
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/gradle/wrapper/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      # 4) Asegurar que el wrapper es ejecutable (necesario en runners Linux)
      - name: Make gradlew executable
        run: chmod +x ./gradlew

      # 5) Ejecutar Detekt para analizar el código antes de compilar
      #    - Ejecutamos la tarea del módulo `app` para generar reportes
      #    - No fallamos inmediatamente para poder subir los reportes y mostrarlos
      - name: Run Detekt
        id: run_detekt
        run: |
          # Ejecutar detekt del módulo app y no terminar el job inmediatamente si falla
          ./gradlew :app:detekt || true
          rc=$?
          echo "detekt_rc=$rc" >> $GITHUB_OUTPUT

      # 6) Subir reportes de Detekt como artifact (si existen)
      #    - Usamos la versión v4 de upload-artifact (no-deprecated)
      - name: Upload Detekt report
        uses: actions/upload-artifact@v4
        with:
          name: detekt-report
          path: |
            app/build/reports/detekt/**/*.html
            app/build/reports/detekt/**/*.xml

      # 7) Fallar el job si Detekt devolvió código de error (es decir, encontró issues)
      - name: Fail if Detekt found issues
        if: ${{ steps.run_detekt.outputs.detekt_rc != '0' }}
        run: |
          echo "Detekt found issues (exit code: ${{ steps.run_detekt.outputs.detekt_rc }})"
          exit 1

      # 8) Compilar la app en modo release
      # Nota: si tu configuración de signing requiere keystore en secrets, habría que añadir pasos para inyectarlo antes de compilar
      - name: Build app (assembleRelease)
        run: ./gradlew clean :app:assembleRelease -Pandroid.debug.obsoleteApi=true

      # 9) Subir los APK/AAB generados como artifact del workflow (para descargas rápidas desde Actions)
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: android-build-artifacts
          path: |
            app/build/outputs/**/*.apk
            app/build/outputs/**/*.aab

      # 10) Buscar la ruta del APK/AAB generados y exportarlas como outputs de este paso
      - name: Find built APK/AAB
        id: find_artifact
        run: |
          # Buscamos APK en la ruta estándar de release
          apk=$(ls app/build/outputs/apk/release/*.apk 2>/dev/null | head -n1 || true)
          # Buscamos AAB (bundle) en la ruta estándar
          aab=$(ls app/build/outputs/bundle/release/*.aab 2>/dev/null | head -n1 || true)
          # Exportar resultados para otros pasos
          echo "apk=$apk" >> $GITHUB_OUTPUT
          echo "aab=$aab" >> $GITHUB_OUTPUT

      # 11) Crear una Release en GitHub para adjuntar los artefactos
      #     - Usa el token provisto por GitHub Actions (secreto automático GITHUB_TOKEN)
      - name: Create GitHub Release
        id: create_release
        uses: actions/create-release@v1
        with:
          tag_name: main-${{ github.run_number }}
          release_name: Release ${{ github.run_number }} (main)
          body: "Automated build triggered by push to main. Artifacts are attached."
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # 12) Adjuntar el APK a la Release (si se generó)
      - name: Upload APK to Release
        if: steps.find_artifact.outputs.apk != ''
        uses: actions/upload-release-asset@v1
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ${{ steps.find_artifact.outputs.apk }}
          asset_name: app-release.apk
          asset_content_type: application/vnd.android.package-archive
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # 13) Adjuntar el AAB a la Release (si se generó)
      - name: Upload AAB to Release
        if: steps.find_artifact.outputs.aab != ''
        uses: actions/upload-release-asset@v1
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ${{ steps.find_artifact.outputs.aab }}
          asset_name: app-release.aab
          asset_content_type: application/octet-stream
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
